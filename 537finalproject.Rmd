---
title: "Untitled"
author: "Bo Zhang"
date: "2023-12-04"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Data Processing
```{r}
library(dplyr)
library(tidyr)
```

## Simulate random variables 
```{r}
set.seed(0)
# Basic, indepedent 
# Sex Income
Sex = rbinom(n = 10000, size = 1, p = 0.48) 
# Age
agesrange <- 50:81
weights <- ifelse(agesrange <= 70, 2.3, 1)
Age <- sample(agesrange, size = 10000, replace = TRUE, prob = weights)
# Income
incomes <- seq(from = 10000, to = 100000, by = 100)
weights <- ifelse(incomes >= 70000, 0.8, 1) 
Income <- sample(incomes, size = 10000, replace = TRUE, prob = weights)

# Stress.Level
Stress.Level<-round(rnorm(10000, mean = (-100+0.08 * Income)/100, sd = 2))
# Exercise.Hours.Per.Week
Exercise.Hours.Per.Week <- numeric(10000)
for(i in 1:10000) {
  base <- 5 
  if(Income[i] > 70000 || Stress.Level[i] < 50) {
    base <- base + 5
  }
  if(Sex[i] == "Female") {
    base <- base - 2
  }
  if(Age[i] > 50) {
    base <- base - 3
  }
  Exercise.Hours.Per.Week[i] <- min(max(round(base + rnorm(1, mean = 0, sd = 10)), 1), 30)
}
# BMI
BMI <- numeric(10000)
for(i in 1:10000) {
  base <- 23
  if(Age[i] > 50) {
    base <- base + 2
  }
  if(Exercise.Hours.Per.Week[i] > 15) {
    base <- base - 2
  }
  if(Sex[i] == "Female") {
    base <- base - 1
  }

  BMI[i] <- round(base + rnorm(1, mean = 0, sd = 2), 1)
}

# Blood.Pressure
Blood.Pressure <- numeric(10000)
for(i in 1:10000) {
  base_systolic <- 120  
  base_diastolic <- 80  
  adj_systolic <- base_systolic + (BMI[i] - 25) + (Age[i] - 50) / 10
  adj_diastolic <- base_diastolic + (BMI[i] - 25) / 2 + (Age[i] - 50) / 20
  Blood.Pressure[i] <- ifelse(130< round(adj_systolic + rnorm(1, mean = 10, sd = 10), 0), 1,0)
}

# Diabetes
Diabetes <- rbinom(10000, size = 1, prob = plogis(-6 + 0.05 * BMI + 0.02 * Age + rnorm(10000, mean = 0.5, sd = 3)))


# Alcohol.Consumption
Alcohol.Consumption <- rbinom(10000, size = 1, prob = plogis(-3 + 0.01 * Stress.Level + 0.03 * Age + rnorm(10000, mean = 0.5, sd = 3)))


# Triglycerides
Triglycerides <- rbinom(10000, size = 1, prob = plogis(-4 + 0.1 * Blood.Pressure + 0.5 * Diabetes +
                                                     0.1 * Alcohol.Consumption + 0.02 * BMI +
                                                     0.01 * Age - 0.01 * Exercise.Hours.Per.Week +
                                                     0.000005 * Income + 0.09 * Stress.Level + 0.3 * Sex +
                                                     rnorm(10000, mean = 0.01, sd = 3)))

# Smoking
Smoking <- rbinom(10000, size = 1, prob = plogis(-5 + 0.1 * Blood.Pressure + 0.1 * Diabetes +
                                                 0.1 * Alcohol.Consumption + 0.05 * BMI +
                                                 0.02 * Age - 0.02 * Exercise.Hours.Per.Week +
                                                 0.00001 * Income + 0.06 * Stress.Level +
                                                 0.2 * Triglycerides + 0.3 * Sex +
                                                 rnorm(10000, mean = 0.01, sd = 1)))


# Heart.Attack.Risk
Heart.Attack <- rbinom(10000, size = 1, prob = plogis(-8+ 2.42 * Smoking -
                                                     0.5 * Sex -
                                                     Smoking * Sex +
                                                     0.3 * Blood.Pressure + 0.6 * Diabetes +
                                                     0.2 * Alcohol.Consumption + 0.03 * BMI +
                                                     0.003 * Age - 0.05 * Exercise.Hours.Per.Week +
                                                     0.000002 * Income + 0.02 * Stress.Level +
                                                     0.4 * Triglycerides +
                                                     rnorm(10000, mean = 0.3, sd = 3)))


# loss_to_follow_up
loss_to_follow_up <- numeric(10000)
for(i in 1:10000) {
  risk <- plogis(-5 + 0.02 * Age[i] + 0.03 * Stress.Level[i] - 0.00001 * Income[i] + 0.04 * BMI[i]+
                  rnorm(1, mean = 0.3, sd = 3))
  loss_to_follow_up[i] <- ifelse(0.99 < risk, 1, 0)
}
sum(loss_to_follow_up)

for(i in 1:10000) {
  if(loss_to_follow_up[i] == 1) {
    Heart.Attack[i] <- NA
  }
}
data <- data.frame(
  Age,
  Sex,
  Exercise.Hours.Per.Week,
  Income,
  Stress.Level,
  BMI,
  Diabetes,
  Blood.Pressure,
  Alcohol.Consumption,
  Triglycerides,
  Smoking,
  Heart.Attack
)
data <- na.omit(data)
head(data, 8)
library(psych)
describe(data)[c('mean', 'sd','min','max', 'skew' )]
```
```{r}
data_smokers <- transform(data, Smoking = 1)

data_nonsmokers <- transform(data, Smoking = 0)

calculate_heart_attack_risk <- function(data) {
 rbinom(10000, size = 1, prob = plogis(-8+ 2.42 * Smoking -
                                                     0.5 * Sex -
                                                     Smoking * Sex +
                                                     0.3 * Blood.Pressure + 0.6 * Diabetes +
                                                     0.2 * Alcohol.Consumption + 0.03 * BMI +
                                                     0.003 * Age - 0.05 * Exercise.Hours.Per.Week +
                                                     0.000002 * Income + 0.02 * Stress.Level +
                                                     0.4 * Triglycerides +
                                                     rnorm(10000, mean = 0.3, sd = 3)))
}

risk_smokers <- calculate_heart_attack_risk(data_smokers)
risk_nonsmokers <- calculate_heart_attack_risk(data_nonsmokers)

risk_ratio <- sum(risk_smokers) / sum(risk_nonsmokers)
risk_ratio
risk_difference <- (sum(risk_smokers) - sum(risk_nonsmokers))/10000
risk_difference
ATE = mean(risk_smokers - risk_nonsmokers)
ATE
```


```{r}
data <- data[c('Smoking', 'Heart.Attack',"Age", "Sex", "Blood.Pressure", "Diabetes", "BMI", "Alcohol.Consumption", "Exercise.Hours.Per.Week",  "Stress.Level", "Income", "Triglycerides")]
# Assuming 'data' is your DataFrame with the blood pressure readings as "systolic/diastolic"

# Convert 'Diabetes' and 'Alcohol.Consumption' from integers to factors
data$Sex <- as.factor(data$Sex)
data$Diabetes <- as.factor(data$Diabetes)
data$Alcohol.Consumption <- as.factor(data$Alcohol.Consumption)
data$Blood.Pressure <- as.factor(data$Blood.Pressure)
data$Smoking <- as.factor(data$Smoking)
data$Heart.Attack <- as.factor(data$Heart.Attack)
data$Triglycerides <- as.factor(data$Triglycerides)
 

# Convert factors to dummy variables
dummy_data <- data %>%
  mutate(across(where(is.factor), as.numeric))

# Now compute the correlation matrix
cor_matrix <- cor(dummy_data, use = "complete.obs")

# Plot
library(corrplot)
# Visualize the correlation matrix
corrplot(cor_matrix, method = "color", order = "hclust",
         tl.col = "black", tl.srt = 45)
```


```{r}
library(ggplot2)
heart_attack_rates <- data %>%
  group_by(Smoking) %>%
  summarize(IncidenceRate = mean(as.numeric(Heart.Attack)-1))
ggplot(heart_attack_rates, aes(x = factor(Smoking), y = IncidenceRate, fill = factor(Smoking))) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = c("blue", "red")) +
  labs(x = "Smoking Status", y = "Incidence Rate of Heart Disease", fill = "Smoking Status") +
  theme_minimal()
```
## Propensity Score
```{r}
data$Sex <- as.numeric(data$Sex)-1
data$Diabetes <- as.numeric(data$Diabetes)-1
data$Alcohol.Consumption <- as.numeric(data$Alcohol.Consumption)-1
data$Blood.Pressure <- as.numeric(data$Blood.Pressure)-1
data$Smoking <- as.numeric(data$Smoking)-1
data$Heart.Attack <- as.numeric(data$Heart.Attack)-1
logit_model <- glm(Smoking ~  Age + Sex + Blood.Pressure + Diabetes + BMI + Alcohol.Consumption + Exercise.Hours.Per.Week + Stress.Level + Income, family = binomial, data = data)
summary(logit_model)
exp(cbind(OR = coef(logit_model), confint(logit_model)))

# propensity score
propensity_model <- glm(Smoking ~  Age + Sex + Blood.Pressure + Diabetes + BMI + Alcohol.Consumption + Exercise.Hours.Per.Week + Stress.Level + Income + Triglycerides, family = binomial(link ="logit"), data = data) 
data$ps <- predict(propensity_model, type = "response")
# Calculate IPW
data$IPW <- ifelse(data$Smoking == 1, 
                       1/data$ps, 
                       1/(1 - data$ps))

# check balance with IPW using ASD
covariates <- c("Age", "Sex", "Blood.Pressure", "Diabetes", "BMI", "Alcohol.Consumption", "Exercise.Hours.Per.Week",  "Stress.Level", "Income", "Triglycerides")
ASD_val <- sapply(covariates, function(var) {
  if (is.numeric(data[[var]])) {
    # Proceed with calculation for numeric variables
    mean_1 <- weighted.mean(data[data$Smoking == 1, var], w = data[data$Smoking == 1, "IPW"])
    mean_0 <- weighted.mean(data[data$Smoking == 0, var], w = data[data$Smoking == 0, "IPW"])
    sd_1 <- sqrt(var(data[data$Smoking == 1, var]))
    sd_0 <- sqrt(var(data[data$Smoking == 0, var]))
    asd <- abs(mean_1 - mean_0) / sqrt((sd_1^2 + sd_0^2) / 2)
  } else {
    # For factors, compare proportions instead of means
    prop_1 <- sum(data[data$Smoking == 1, var] == 1, na.rm = TRUE) / sum(data$Smoking == 1, na.rm = TRUE)
    prop_0 <- sum(data[data$Smoking == 0, var] == 1, na.rm = TRUE) / sum(data$Smoking == 0, na.rm = TRUE)
    asd <- abs(prop_1 - prop_0) # For binary factors, standard deviation is not required
  }
  return(asd)
})
print(ASD_val) # all good balance
```

```{r}
hist(data$IPW)
# OK
```

```{r}
library(ggplot2)
ggplot(data, aes(x=ps, fill=factor(Smoking))) + 
  geom_histogram(alpha=0.5, position="identity", bins=30) + 
  labs(title="Histogram of Propensity Scores by Smoking", x="Propensity Score", fill="Smoking") + 
  theme_minimal()
```

## Love plot
```{r}
covariates <- c("Age", "Sex", "Blood.Pressure", "Diabetes", "BMI", "Alcohol.Consumption", "Exercise.Hours.Per.Week", "Stress.Level", "Income")
data$OW <- ifelse(data$Smoking == 1, 1 - data$ps, data$ps)

ASD_val_ori <- sapply(covariates, function(var) { 
   if (is.numeric(data[[var]])) {
      mean1 <- mean(data[data$Smoking == 1, var]) 
      mean0 <- mean(data[data$Smoking == 0, var]) 
      sd1 <- sd(data[data$Smoking == 1, var]) 
      sd0 <- sd(data[data$Smoking == 0, var]) 
      asd <- abs(mean1 - mean0) / sqrt((sd1^2 + sd0^2) / 2)
   } else {
      prop1 <- sum(data[data$Smoking == 1, var] == 1, na.rm = TRUE) / sum(data$Smoking == 1, na.rm = TRUE)
      prop0 <- sum(data[data$Smoking == 0, var] == 1, na.rm = TRUE) / sum(data$Smoking == 0, na.rm = TRUE)
      asd <- abs(prop1 - prop0)
   }
   return(asd)
})

ASD_IPW <- sapply(covariates, function(var) { 
  if (is.numeric(data[[var]])) {
      mean1 <- weighted.mean(data[data$Smoking == 1, var], w = data[data$Smoking == 1, "IPW"]) 
      mean0 <- weighted.mean(data[data$Smoking == 0, var], w = data[data$Smoking == 0, "IPW"]) 
      sd1 <- sd(data[data$Smoking == 1, var]) 
      sd0 <- sd(data[data$Smoking == 0, var]) 
      asd <- abs(mean1 - mean0) / sqrt((sd1^2 + sd0^2) / 2)
  } else {
      prop1 <- sum(data[data$Smoking == 1, var] == 1, na.rm = TRUE) / sum(data$Smoking == 1, na.rm = TRUE)
      prop0 <- sum(data[data$Smoking == 0, var] == 1, na.rm = TRUE) / sum(data$Smoking == 0, na.rm = TRUE)
      asd <- abs(prop1 - prop0)
  }
  return(asd)
})

ASD_OW <- sapply(covariates, function(var) {
  if (is.numeric(data[[var]])) {
      mean1 <- weighted.mean(data[data$Smoking == 1, var], w = data[data$Smoking == 1, "OW"]) 
      mean0 <- weighted.mean(data[data$Smoking == 0, var], w = data[data$Smoking == 0, "OW"]) 
      sd1 <- sd(data[data$Smoking == 1, var]) 
      sd0 <- sd(data[data$Smoking == 0, var]) 
      asd <- abs(mean1 - mean0) / sqrt((sd1^2 + sd0^2) / 2)
  } else {
      prop1 <- sum(data[data$Smoking == 1, var] == 1, na.rm = TRUE) / sum(data$Smoking == 1, na.rm = TRUE)
      prop0 <- sum(data[data$Smoking == 0, var] == 1, na.rm = TRUE) / sum(data$Smoking == 0, na.rm = TRUE)
      asd <- abs(prop1 - prop0)
  }
  return(asd)
})
love_data <- data.frame( 
  Covariate = rep(covariates,3), 
  ASD = c(ASD_val_ori, ASD_IPW, ASD_OW),
  Method = factor(rep(c("Original","IPW","OW"), 
                      each = length(covariates)), 
                  levels = c("Original","IPW","OW")))
ggplot(love_data, aes(x = ASD, y = Covariate, color = Method)) + 
  geom_point(size = 3) + 
  geom_vline(xintercept = 0, linetype = "dashed", color = "red") + 
  labs(title = "Love Plot of ASDs", x = "Absolute Standardized Difference", y = "Covariate") +
  scale_color_brewer(palette = "Set1") +
  theme(axis.text.y = element_text(angle = 45, hjust = 1))

```


## Table

```{r}
library(gt)

# Compute average values for each group in the original data
avg_original_smokers <- lapply(covariates, function(var) mean(data[data$Smoking == 1, var]))
avg_original_nonsmokers <- lapply(covariates, function(var) mean(data[data$Smoking == 0, var]))

# Compute average values using IPW for smokers and non-smokers
avg_ipw_smokers <- lapply(covariates, function(var) { 
  weighted.mean(data[data$Smoking == 1, var], data[data$Smoking == 1, "IPW"])
})
avg_ipw_nonsmokers <- lapply(covariates, function(var) {
  weighted.mean(data[data$Smoking == 0, var], data[data$Smoking == 0, "IPW"])
})

# Compute average values using OW for smokers and non-smokers
avg_ow_smokers <- lapply(covariates, function(var) { 
  weighted.mean(data[data$Smoking == 1, var], data[data$Smoking == 1, "OW"])
})
avg_ow_nonsmokers <- lapply(covariates, function(var) {
  weighted.mean(data[data$Smoking == 0, var], data[data$Smoking == 0, "OW"])
})

# Combine all calculated averages
combined_averages <- data.frame(
  Covariate = covariates,
  Avg_Original_Smokers = unlist(avg_original_smokers),
  Avg_IPW_Smokers = unlist(avg_ipw_smokers),
  Avg_OW_Smokers = unlist(avg_ow_smokers),
  Avg_Original_Nonsmokers = unlist(avg_original_nonsmokers),
  Avg_IPW_Nonsmokers = unlist(avg_ipw_nonsmokers),
  Avg_OW_Nonsmokers = unlist(avg_ow_nonsmokers)
)

# Display the results in a formatted table
formatted_table <- gt(data = combined_averages) %>%
  tab_header(
    title = "Table 1: Comparative Averages Based on Smoking Status"
  ) %>%
  cols_label(
    Covariate = "Covariate",
    Avg_Original_Smokers = "Original Avg (Smokers)",
    Avg_IPW_Smokers = "IPW Avg (Smokers)",
    Avg_OW_Smokers = "OW Avg (Smokers)",
    Avg_Original_Nonsmokers = "Original Avg (Nonsmokers)",
    Avg_IPW_Nonsmokers = "IPW Avg (Nonsmokers)",
    Avg_OW_Nonsmokers = "OW Avg (Nonsmokers)"
  ) %>%
  tab_spanner(
    label = "Smokers",
    columns = vars(Avg_Original_Smokers, Avg_IPW_Smokers, Avg_OW_Smokers)
  ) %>%
  tab_spanner(
    label = "Nonsmokers",
    columns = vars(Avg_Original_Nonsmokers, Avg_IPW_Nonsmokers, Avg_OW_Nonsmokers)
  )
formatted_table

```


## risk ratio (RR) with an outcome regression (OR) estimator
```{r}
# Linear Model for Combined Data
combined_model <- lm(Heart.Attack ~ Smoking + ., data = data)

# Prediction using the Combined Model
predicted_outcomes <- predict(combined_model, newdata = data)

# Separate Predictions for Different Smoking Statuses
predictions_smokers <- predicted_outcomes[data$Smoking == 1]
predictions_non_smokers <- predicted_outcomes[data$Smoking == 0]

# Average Predicted Outcomes
avg_outcome_smokers <- mean(predictions_smokers)
avg_outcome_non_smokers <- mean(predictions_non_smokers)

# Calculations for Risk Difference and Risk Ratio
risk_difference <- avg_outcome_smokers - avg_outcome_non_smokers
risk_ratio <- avg_outcome_smokers / avg_outcome_non_smokers
risk_difference
risk_ratio

# Bootstrap Analysis
set.seed(123)  # Ensuring reproducibility
num_iterations <- 1000
num_samples <- nrow(data)

# Arrays to Store Bootstrap Results
bootstrap_results_RD <- numeric(num_iterations)
bootstrap_results_RR <- numeric(num_iterations)

for (i in 1:num_iterations) {
  # Drawing a Bootstrap Sample
  sampled_data <- data[sample(1:num_samples, num_samples, replace = TRUE), ]
  
  # Model Fitting on the Sampled Data
  model_on_sample <- lm(Heart.Attack ~ Smoking + ., data = sampled_data)
  sample_predictions <- predict(model_on_sample, newdata = sampled_data)
  
  # Predictions Based on Smoking Status in the Sample
  sample_predictions_smokers <- sample_predictions[sampled_data$Smoking == 1]
  sample_predictions_non_smokers <- sample_predictions[sampled_data$Smoking == 0]
  
  # RD and RR for Each Sample
  bootstrap_results_RD[i] <- mean(sample_predictions_smokers) - mean(sample_predictions_non_smokers)
  bootstrap_results_RR[i] <- mean(sample_predictions_smokers) / mean(sample_predictions_non_smokers)
}

# Confidence Intervals from Bootstrap Results
bootstrap_CI_RD <- quantile(bootstrap_results_RD, c(0.025, 0.975))
bootstrap_CI_RR <- quantile(bootstrap_results_RR, c(0.025, 0.975))
bootstrap_CI_RD
bootstrap_CI_RR

```

## RR with propensity score  with estimated propensity scores
```{r}
# Regression Models for Heart Attack based on Propensity Score
model_smokers <- lm(Heart.Attack ~ ps, data = data[data$Smoking == 1,])
model_nonsmokers <- lm(Heart.Attack ~ ps, data = data[data$Smoking == 0,])

# Predicted Outcomes from Models
predicted_outcome_smokers <- predict(model_smokers, newdata = data)
predicted_outcome_nonsmokers <- predict(model_nonsmokers, newdata = data)

# Calculation of Risk Difference and Risk Ratio
risk_diff <- mean(predicted_outcome_smokers) - mean(predicted_outcome_nonsmokers)
risk_ratio <- mean(predicted_outcome_smokers) / mean(predicted_outcome_nonsmokers)
risk_diff
risk_ratio

# Bootstrap Analysis Setup
set.seed(123)  # Seed for reproducibility
sample_size <- nrow(data)
bootstrap_iterations <- 1000

# Arrays for Storing Bootstrap Results
bootstrap_results_risk_diff <- numeric(bootstrap_iterations)
bootstrap_results_risk_ratio <- numeric(bootstrap_iterations)

for (iteration in 1:bootstrap_iterations) {
  # Bootstrap Resampling
  sampled_data <- data[sample(1:sample_size, sample_size, replace = TRUE), ]
  
  # Models for Each Resampled Data
  model_resample_smokers <- lm(Heart.Attack ~ ps, data = sampled_data[sampled_data$Smoking==1,])
  model_resample_nonsmokers <- lm(Heart.Attack ~ ps, data = sampled_data[sampled_data$Smoking==0,])
  
  # Predictions for Resampled Data
  predictions_resample_smokers <- predict(model_resample_smokers, newdata = sampled_data)
  predictions_resample_nonsmokers <- predict(model_resample_nonsmokers, newdata = sampled_data)
  
  # Risk Difference and Ratio for Each Bootstrap Sample
  bootstrap_results_risk_diff[iteration] <- mean(predictions_resample_smokers) - mean(predictions_resample_nonsmokers)
  bootstrap_results_risk_ratio[iteration] <- mean(predictions_resample_smokers) / mean(predictions_resample_nonsmokers)
}

# Computing Confidence Intervals from Bootstrap Results
conf_int_risk_diff <- quantile(bootstrap_results_risk_diff, c(0.025, 0.975))
conf_int_risk_ratio <- quantile(bootstrap_results_risk_ratio, c(0.025, 0.975))
conf_int_risk_diff
conf_int_risk_ratio

```

## Risk Ratio (RR) with propensity score  with IPW estimator
```{r}
library(PSweight)
formula <- reformulate(covariates, response="Smoking")
data$Heart.Attack <- as.numeric(as.character(data$Heart.Attack))
data$Smoking <- as.numeric(as.character(data$Smoking))
ipw <- PSweight(ps.formula = formula, yname = 'Heart.Attack', data = data, weight = "IPW") # RD:
summary(ipw, type = 'DIF', CI = TRUE)[1]
summary(ipw, type = 'RR', CI=TRUE)[1]
```
## Risk Ratio (RR) with propensity score  with OW estimator
```{r}
ow <- PSweight(ps.formula = formula, yname = 'Heart.Attack', data = data, weight = "overlap") # RD:
print(summary(ow, type = 'DIF', CI=TRUE)[1])
print(summary(ow, type = 'RR', CI=TRUE)[1])
```

## Sensitivity analysis
```{r}
## logistic regression -- obtain the conditional odds ratio
library(EValue)
lead.loglinear = glm(Heart.Attack ~ ., family = binomial(link = "logit"),  data = data)
est_se = summary(lead.loglinear)$coef["Smoking", c(1, 2)]

est      = RR(exp(est_se[1]))
lowerRR  = exp(est_se[1] - 1.96*est_se[2])
upperRR  = exp(est_se[1] + 1.96*est_se[2])
evalue(est, lowerRR, upperRR)

#找or的公式写paper里
#unmeasured confounders
```

```{r}
# Convert 'Diabetes' and 'Alcohol.Consumption' from integers to factors
data$Sex <- as.factor(data$Sex)
data$Diabetes <- as.factor(data$Diabetes)
data$Alcohol.Consumption <- as.factor(data$Alcohol.Consumption)
data$Blood.Pressure <- as.factor(data$Blood.Pressure)
data$Smoking <- as.factor(data$Smoking)
data$Heart.Attack <- as.factor(data$Heart.Attack)
 
# Convert factors to dummy variables
dummy_data <- data %>%
  mutate(across(where(is.factor), as.numeric)) #%>%
 # select(where(is.numeric))

dummy_data$Sex<-dummy_data$Sex-1
dummy_data$Diabetes<-dummy_data$Diabetes-1
dummy_data$Blood.Pressure<-dummy_data$Blood.Pressure-1
dummy_data$Alcohol.Consumption<-dummy_data$Alcohol.Consumption-1
dummy_data$Smoking<-dummy_data$Smoking-1
dummy_data$Heart.Attack<-dummy_data$Heart.Attack-1
```

## ATE (direct regression)

```{r direct regression}
direct_reg_model <- lm(Heart.Attack ~ Smoking + Age + Sex + Blood.Pressure + Diabetes + BMI + Alcohol.Consumption + Exercise.Hours.Per.Week + Stress.Level + Income, data = dummy_data)
att_estimate <- coef(direct_reg_model)["Smoking"]
att_estimate
SE_ATE <- summary(direct_reg_model)$coef['Smoking', 'Std. Error']
SE_ATE
```

## ATE (matching estimator)

```{r matching estimator}
library(MatchIt)
library(Matching)
match_data <- Match(Y = dummy_data$Heart.Attack, Tr = dummy_data$Smoking, X = dummy_data[, c("Age", "Sex", "Blood.Pressure", "Diabetes", "BMI", "Alcohol.Consumption", "Exercise.Hours.Per.Week",  "Stress.Level", "Income")])
att_estimate.1 <- summary(match_data)
```

## ATE (IPW)

```{r}
#confounders include age/ sex/ diabetes/ blood pressure/ BMI/ alchohol consumption/ stress level/ exercise hours per week/ Income
library(PSweight)
ps.smoking.mult<-Smoking ~  Age + Sex + Blood.Pressure + Diabetes + BMI + Alcohol.Consumption + Exercise.Hours.Per.Week + Stress.Level + Income
ps_weights_smoking_ipw <- PSweight(ps.formula = ps.smoking.mult, data = dummy_data,
weight = "IPW",trtgrp = "1",zname = "Smoking",yname = "Heart.Attack",
bootstrap = TRUE,R = 100)
att_weighting_smoking_ipw <- summary(ps_weights_smoking_ipw)$estimates["Contrast 1", "Estimate"]
se_att_weighting_smoking_ipw <- summary(ps_weights_smoking_ipw)$estimates["Contrast 1", "Std.Error"]
att_weighting_smoking_ipw 
se_att_weighting_smoking_ipw
```


## ATO
```{r propensity score calculation: smoking}
#confounders include age/ sex/ diabetes/ blood pressure/ BMI/ alchohol consumption/ stress level/ exercise hours per week/ Income
library(PSweight)
ps.smoking.mult<-Smoking ~  Age + Sex + Blood.Pressure + Diabetes + BMI + Alcohol.Consumption + Exercise.Hours.Per.Week + Stress.Level + Income
#ATT estimate
ps_weights_smoking <- PSweight(ps.formula = ps.smoking.mult, data = dummy_data,
weight = "overlap",trtgrp = "1",zname = "Smoking",yname = "Heart.Attack",
bootstrap = TRUE,R = 100)
att_weighting_smoking <- summary(ps_weights_smoking)$estimates["Contrast 1", "Estimate"]
se_att_weighting_smoking <- summary(ps_weights_smoking)$estimates["Contrast 1", "Std.Error"]
att_weighting_smoking 
se_att_weighting_smoking
```

## ATE (doubly robust estimator)
```{r doubly robust estimator:smoking}
###double robust estimator
ps_smoking_formula <- Smoking ~  Age + Sex + Blood.Pressure + Diabetes + BMI + Alcohol.Consumption + Exercise.Hours.Per.Week + Stress.Level + Income
or_smoking_formula <- Heart.Attack ~ Smoking + Age + Sex + Blood.Pressure + Diabetes + BMI + Alcohol.Consumption + Exercise.Hours.Per.Week + Stress.Level + Income
# Use PSweight to estimate ATT using a doubly robust estimator obverlap weights
ps_smoking <- PSweight(ps.formula = ps_smoking_formula, data = dummy_data,
weight = "IPW",trtgrp = "1",zname = "Smoking",yname = "Heart.Attack",out.formula = or_smoking_formula,
bootstrap = TRUE,R = 100)
summary(ps_smoking)
```

## ATE (GBM)
```{r machine learning propensity score estimation}
ps.smoking.gbm <- Smoking ~  Age + Sex + Blood.Pressure + Diabetes + BMI + Alcohol.Consumption + Exercise.Hours.Per.Week + Stress.Level + Income
bal.any.gbm <-SumStat(ps.formula = ps.smoking.gbm, data= dummy_data, weight = "overlap",
method = "gbm", ps.control = list(distribution = "adaboost"))
out.smoking.gbm <- Heart.Attack ~ Smoking + Age + Sex + Blood.Pressure + Diabetes + BMI + Alcohol.Consumption + Exercise.Hours.Per.Week + Stress.Level + Income
ato.smoking.aug.gbm <- PSweight(ps.formula = ps.smoking.gbm, data = dummy_data,trtgrp = "1",zname = "Smoking", yname = "Heart.Attack", out.formula = out.smoking.gbm, ps.method = "gbm", ps.control = list(distribution = "adaboost"),out.method = "gbm",bootstrap = TRUE,R = 100)
summary(ato.smoking.aug.gbm)

```

## subgroup analysis

```{r subgroup analysis}
# we separately calculate the ate in different sex groups
ps_subgroup_formula <- Smoking ~  Age + Blood.Pressure + Diabetes + BMI + Alcohol.Consumption + Exercise.Hours.Per.Week + Stress.Level + Income
data0<-dummy_data[dummy_data$Sex == 0,]
data1<-dummy_data[dummy_data$Sex == 1,]
ps_weights_smoking0 <- PSweight(ps.formula = ps_subgroup_formula, data = data0,
weight = "overlap",trtgrp = "1",zname = "Smoking",yname = "Heart.Attack",
bootstrap = TRUE,R = 100)
att_weighting_smoking0 <- summary(ps_weights_smoking0)$estimates["Contrast 1", "Estimate"]
se_att_weighting_smoking0 <- summary(ps_weights_smoking0)$estimates["Contrast 1", "Std.Error"]
att_weighting_smoking0 
se_att_weighting_smoking0
ps_weights_smoking1 <- PSweight(ps.formula = ps_subgroup_formula, data = data1,
weight = "overlap",trtgrp = "1",zname = "Smoking",yname = "Heart.Attack",
bootstrap = TRUE,R = 100)
att_weighting_smoking1 <- summary(ps_weights_smoking1)$estimates["Contrast 1", "Estimate"]
se_att_weighting_smoking1 <- summary(ps_weights_smoking1)$estimates["Contrast 1", "Std.Error"]
att_weighting_smoking1 
se_att_weighting_smoking1

```

```{r subgroup analysis by comorbidities in diabetes}
# we separately calculate the ate in diabetes patients
ps_subgroup_formula_d <- Smoking ~  Age + Sex+ Blood.Pressure + BMI + Alcohol.Consumption + Exercise.Hours.Per.Week + Stress.Level + Income
data0d<-dummy_data[dummy_data$Diabetes == 0,]
data1d<-dummy_data[dummy_data$Diabetes == 1,]
ps_weights_d0 <- PSweight(ps.formula = ps_subgroup_formula_d, data = data0d,
weight = "overlap",trtgrp = "1",zname = "Diabetes",yname = "Heart.Attack",
bootstrap = TRUE,R = 100)
att_weighting_d0 <- summary(ps_weights_d0)$estimates["Contrast 1", "Estimate"]
se_att_weighting_d0 <- summary(ps_weights_d0)$estimates["Contrast 1", "Std.Error"]
att_weighting_d0 
se_att_weighting_d0
ps_weights_d1 <- PSweight(ps.formula = ps_subgroup_formula_d, data = data1d,
weight = "overlap",trtgrp = "1",zname = "Diabetes",yname = "Heart.Attack",
bootstrap = TRUE,R = 100)
att_weighting_d1 <- summary(ps_weights_d1)$estimates["Contrast 1", "Estimate"]
se_att_weighting_d1 <- summary(ps_weights_d1)$estimates["Contrast 1", "Std.Error"]
att_weighting_d1 
se_att_weighting_d1
```

```{r subgroup analysis by comorbidities in hypertension}
# we separately calculate the ate in hypertension patients
ps_subgroup_formula_h <- Smoking ~  Age + Sex+ Diabetes + BMI + Alcohol.Consumption + Exercise.Hours.Per.Week + Stress.Level + Income
data0h<-dummy_data[dummy_data$Blood.Pressure == 0,]
data1h<-dummy_data[dummy_data$Blood.Pressure == 1,]
ps_weights_h0 <- PSweight(ps.formula = ps_subgroup_formula_h, data = data0h,
weight = "overlap",trtgrp = "1",zname = "Blood.Pressure",yname = "Heart.Attack",
bootstrap = TRUE,R = 50)
att_weighting_h0 <- summary(ps_weights_h0)$estimates["Contrast 1", "Estimate"]
se_att_weighting_h0 <- summary(ps_weights_h0)$estimates["Contrast 1", "Std.Error"]
att_weighting_h0 
se_att_weighting_h0
ps_weights_h1 <- PSweight(ps.formula = ps_subgroup_formula_h, data = data1h,
weight = "overlap",trtgrp = "1",zname = "Blood.Pressure",yname = "Heart.Attack",
bootstrap = TRUE,R = 50)
att_weighting_h1 <- summary(ps_weights_h1)$estimates["Contrast 1", "Estimate"]
se_att_weighting_h1 <- summary(ps_weights_h1)$estimates["Contrast 1", "Std.Error"]
att_weighting_h1 
se_att_weighting_h1
```

